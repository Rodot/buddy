# Buddy

## Contribution rules

- Always run and pass `./run_quality.sh` after any change

## Tech stack

### App

- React v19.2 (frontend AND backend using Server Components and Functions)
- React Compiler. Automatic optimization. do NOT use useMemo, useCallback, React.memo, memo, as it will be generated by the compiler. Write straightforward code and let the compiler optimize it.
- React-router v7
- Tanstack Query
- Vite
- No database, client side local storage only

### UI

- Tailwind
- Daisy UI, theme in app/app.css
- Icons from "@mdi/js" using app/components/MdiIcon.tsx

### Quality

- TypeScript
- ESLint
- Prettier
- Markdownlint
- Shellcheck
- Playwright

### Packaging

- All-in-one docker image

## Architecture

### Domain and Dto

Strict separation between the domain model and the Dtos/Api. Only the api layer is aware of the Dtos, the rest of the app uses Models

### Files structure

- **types/domain/** contains `xxxModel.type.ts`
- **types/dto/** contains `xxxDto.type.ts`
- **types/input/** contains `xxxInput.type.ts` (for form input types, should be merged into Models eventually)
- **converters/** contains all DTO/Model conversion functions
  - `xxxFromxxx.convert.ts` with function `xxxFromxxx`
- **defaults/** contains meaningful default value constants
  - `xxx.default.ts` with constant `xxxDefault`
  - All defaults should be properly typed constants, not functions
  - Do not create default files for empty arrays or objects - use inline values instead
- **consts/** contains constant definitions
  - `xxx.const.ts` with exported constants in UPPER_SNAKE_CASE
- **providers/** contains React context providers
  - `xxx.provider.tsx`
- **logic/** contains pure functions that handle business logic
  - `xxx.logic.ts`
- **pages/** contains page components
  - `xxx.page.tsx`
- **services/** contains API service layer
  - `xxx.service.ts` (except `api.ts` which is the base API client)

### Queries

- All async queries and mutation are done using TanStack Query
- Read data using custom hooks in `./hooks/use**Query.ts`
- Mutate state by calling mutations in `./hooks/use**Query.ts` that call services

### Components

- Components use hooks for data fetching rather than prop drilling
- `/components/` contains all UI components

### E2E

- Always use html id tag to locate components
- If a component don't have an html id tag yet, you can add it

## Main Components Responsibilities

### Key Principles

- **Single Orchestrator**: Engine provider is THE ONLY orchestrator. It owns all service instances, subscribes to all service events, manages all state machines, and exposes state + callbacks to components.
- **Dumb Components**: Components/Pages NEVER import services. They NEVER subscribe to events. They ONLY read state from engine provider and call its callbacks.
- **Single Source of Truth**: Each service manages its own domain state. Engine provider orchestrates and exposes derived state to the React tree.

### Services

- `transcription.service.ts` Manages real-time audio transcription via OpenAI Realtime API and emits transcription/VAD/connection events
- `conversation.service.ts` Manages conversation state in localStorage (single source of truth) and emits new answer events
- `completion.service.ts` Fetches AI completions and emits thinking state events
- `wake-lock.service.ts` Manages screen wake lock to prevent phone screen from locking during active use

### Providers

- `engine.provider.tsx` The single orchestrator. Owns all service instances, subscribes to all service events (VAD, transcription, connection), manages the engine state machine (sleeping, listening, thinking, talking), orchestrates the conversation loop (transcription → conversation → completion), and exposes ONLY state and callbacks to components (never raw service instances)

### Pages

- `root.tsx` Handles routing based on `isConnected` state from engine provider
- `connect.tsx` Provides language selection UI, calls `connect(language)` and `clearConversation()` callbacks from engine provider
- `chat.tsx` Displays chat UI based on `state` and `lastAnswer` from engine provider, calls `disconnect()` callback
